<!DOCTYPE html>
<html lang="ru"><head>
  <meta charset="utf-8">
  <title>Пример графика с временным рядом</title>
  <script src="./scripts/chart.umd.min_v4.2.0.js"></script>
  <script src="./scripts/moment-with-locales.min_v2.29.4.js"></script>
  <script src="./scripts/chartjs-adapter-moment.min_v1.0.1.js"></script>
  <style>
    @font-face {
      font-family: GOST;
      src: url(./fonts/MipGostZero.ttf);
    }
    body {
      font-family: GOST;
      font-size: 16pt;
    }
  </style>
</head>
<body>
<h3>Пример графика с временным рядом</h3>
Используем следующие модули JavaScript:
<ul>
  <li>Chart - модуль для отрисовки графиков и диаграмм (см. <a href="https://www.chartjs.org/docs/latest/" target="_blank">источник</a>)</li>
  <li>Moment - модуль для работы с датой и временем (см. <a href="https://momentjs.com/docs/#/parsing/" target="_blank">источник</a>)</li>
  <li>chartjs-adapter-moment - адаптер для связи Chart c Moment (см. <a href="https://github.com/chartjs/chartjs-adapter-moment" target="_blank">источник</a>)</li>
</ul>
<hr>
<header></header>
<input id="ChartRefresh1" value="Обновить показания датчиков (запрос на сервер)" type="button">
<canvas id="chart1" width="800" height="250"></canvas>
<section></section>


<script>
const URL = 'https://my-json-server.typicode.com/valeriy-egorov/FakeOnlineRESTserver/DATA';
var Chart1;						//Экземпляр объекта Chart
var Sensor;						//Массив данных полученных от сервера
const ColorLeft = 'rgb(255, 100, 100)';			//Настройки графика
const ColorRight = 'rgb(100, 100, 255)';		//Настройки графика
moment.locale('ru');					//Настройки графика. Переключение языка на русский для строк с датой

var Index;						//Для демонстрации
var Data;						//Для демонстрации
var Index = 0;						//Для демонстрации

//Функция обработки нажатия на кнопку ChartRefresh1
ChartRefresh1.onclick = function() {
  DataFetch(URL);
  };
  
//Функция получения и отображения данных с сервера
async function DataFetch(strURL) {
  const Requ = new Request(strURL);
  const Resp = await fetch(Requ);
  const Data = await Resp.json();
  
  //Для демонстрации
  Sensor = Data[Index % 2];				//Для демонстрации изменяющихся данных
  Index += 1;						//Для демонстрации
  console.log(Sensor);					//Для отладки
  
  //Манипуляции с тэгами HTML
  const TagHeader = document.querySelector('header');	//Запрашиваем элемент <header> из документа
  const DataName = document.createElement('div');	//Создаём элемент DataName
  DataName.textContent = Index + ' ответ от сервера, массив длиной ' + Sensor.air.length;
  TagHeader.appendChild(DataName);			//Добавляем в элемент <header> подготовленный элемент DataName
  const Section = document.querySelector('section');	//Запрашиваем элемент <selection> из документа
  for (const Rec of Sensor.air) {			//Цикл по всем записям Sensor.air
    const Article = document.createElement('article');	//Создаём элемент Article
    const Para = document.createElement('span');	//Создаём элемент Para
    Para.textContent = `Дата: ${Rec.dt}`;		//Заполняем свойства элемента
    Article.appendChild(Para);				//Добавляем в элемент Article подготовленный элемент Para
    Section.appendChild(Article);			//Добавляем в элемент <section> подготовленный элемент Article
    }
    
  //Манипуляции с графиком
  if (Chart1 != undefined) {				//Экземпляр объекта Chart существует?
    Chart1.data.datasets.forEach(dataset => {
        dataset.data = Sensor.air;			//Обновить данные
      });
    Chart1.update("resize");					//Обновить график
    } else {
    Chart1 = new Chart('chart1', {			//Создаём один раз и потом используем
      type: 'line',
      data: {
        datasets: [
          {
          label: 'Температура1',
          data: Sensor.air,
          yAxisID: 'y',
          parsing: {xAxisKey: "dt", yAxisKey: "t1"},	//задание соответствия полей данных к осям
          showLine: true,
          hidden: false,
          lineTension: 0.3,					//коэффициент сглаживания кривой
          borderColor: ColorLeft},
          {
          label: 'Температура2',
          data: Sensor.air,
          yAxisID: 'y',
          parsing: {xAxisKey: "dt", yAxisKey: "t2"},
          showLine: true,
          hidden: true,
          lineTension: 0.3,
          borderColor: ColorLeft},
          {
          label: 'Температура3',
          data: Sensor.air,
          yAxisID: 'y',
          parsing: {xAxisKey: "dt", yAxisKey: "t3"},
          showLine: true,
          hidden: true,
          lineTension: 0.3,
          borderColor: ColorLeft},
          {
          label: 'Температура4',
          data: Sensor.air,
          yAxisID: 'y',
          parsing: {xAxisKey: "dt", yAxisKey: "t4"},
          showLine: true,
          hidden: true,
          lineTension: 0.3,
          borderColor: ColorLeft},
          {
          label: 'Влажность1',
          data: Sensor.air,
          yAxisID: 'yRight',
          parsing: {xAxisKey: "dt", yAxisKey: "h1"},
          showLine: true,
          hidden: false,
          lineTension: 0.3,
          borderColor: ColorRight},
          {
          label: 'Влажность2',
          data: Sensor.air,
          yAxisID: 'yRight',
          parsing: {xAxisKey: "dt", yAxisKey: "h2"},
          showLine: true,
          hidden: true,
          lineTension: 0.3,
          borderColor: ColorRight},
          {
          label: 'Влажность3',
          data: Sensor.air,
          yAxisID: 'yRight',
          parsing: {xAxisKey: "dt", yAxisKey: "h3"},
          showLine: true,
          hidden: true,
          lineTension: 0.3,
          borderColor: ColorRight},
          {
          label: 'Влажность4',
          data: Sensor.air,
          yAxisID: 'yRight',
          parsing: {xAxisKey: "dt", yAxisKey: "h4"},
          showLine: true,
          hidden: true,
          lineTension: 0.3,
          borderColor: ColorRight},
        ],
      },
      options: {
        locale: "ru-RU",
        animation: false,
        plugins: {
          title: {
            display: true,
            text: 'Датчики воздуха',
          },
          legend: {
            labels: {
              font: {
	        family: "GOST",				//Переопределение свойств по умолчанию на ...
                size: 14
                }
              }
            }	  
        },
        layout: {
          padding: {
            top: 80
            }
        },
        scales: {
          x: {
            type: 'time',
	    //min: 1674111100000,
	    //max: 1674111285000,
            //offsetAfterAutoskip: false,
	    title: {
  	    display: true,
  	    text: "Ось времени ",
	    },
            time: {
  	      //unit: 'second',				//Ручное задание
  	      //round: 'second',				//Ручное задание
	      //tooltipFormat: '<hh:mm:ss>',		//Ручное задание формата даты и времени
	      isoWeekday: true,
	      minUnit: 'second',
              displayFormats: {				//форматы для разных масштабов по оси времени
  	      millisecond: 'mm:ss.SSS',
  	      second: 'hh:mm:ss',
	        minute: 'D hh:mm',
	        hour: 'D MMM hh:mm',
	        day: 'D MMM hh:mm',
	        week: 'D MMM hh:mm',
	        month: 'D MMM yyyy',
	        quarter: 'D MMM yyyy',
	        year: 'D MMM yyyy'
              }
            },
            ticks: {
              source: "data",
              color: "black",
	      display: true,
	      //textStrokeWidth: 20,
	      //major: {enabled: true},
              font: {
                //weight: "bold"
	      },
              //callback: function(val, index) {	//спрятать каждую 2ю метку
              //  return index % 2 === 0 ? this.getLabelForValue(val) : '';
              //},
            },
            grid: {
              drawTicks: true,
	      //drawOnChartArea: false,
              //color: "blue",
              borderColor: "black",
	      enabled: true,
	      drawTicks: true,
	      lineWidth: 1,					//толщина линий сетки
	      //offset: true,
              //borderDash: [4, 8],
            },
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
	    //min: 0,
	    border: {
  	    color: ColorLeft,
	    },
            ticks: {
              color: ColorLeft,
	      //padding: 40,
	    },
	    title: {
  	    display: true,
  	    color: ColorLeft,
	      text: "Температура",
	    },
            grid: {
  	    //drawOnChartArea: false,
  	    //offset: true,
              //color: ColorLeft,
              },
          },
          yRight: {
            type: 'linear',
            display: true,
            position: 'right',
	    border: {
  	    color: ColorRight
            },
            ticks: {
              color: ColorRight
	    },
	    title: {
  	    display: true,
  	    color: ColorRight,
	      text: "Влажность",
	    },
            grid: {
              color: ColorRight,
              drawOnChartArea: false,
            }
          }
        }
      }
      });
    }
  }
  
</script>
<!--const Data1 = {						//Формат ответа сервера
  air: [
    {dt:1674111120000, t1:30.29, h1:72.19, t2:31.20, h2:73.64, t3:30.83, h3:73.28, t4:29.97, h4:41.70},
    {dt:1674111125000, t1:26.13, h1:43.23, t2:29.13, h2:67.67, t3:30.67, h3:76.97, t4:29.00, h4:81.98},
    {dt:1674111130000, t1:29.52, h1:77.48, t2:31.17, h2:61.83, t3:29.01, h3:45.93, t4:29.31, h4:56.59},
    {dt:1674111135000, t1:"null",  h1:"null",  t2:30.42, h2:77.29, t3:null,  h3:null,  t4:29.03, h4:38.47},
    {dt:1674111140000, t1:"null",  h1:"null",  t2:29.42, h2:77.29, t3:30.94, h3:59.53, t4:29.03, h4:38.47},
    {dt:1674111145000, t1:"null",  h1:"null",  t2:28.42, h2:77.29, t3:30.94, h3:59.53, t4:29.03, h4:38.47},
    {dt:1674111150000, t1:30.77, h1:58.89, t2:30.42, h2:77.29, t3:30.94, h3:59.53, t4:29.03, h4:38.47},
    {dt:1674111155000, t1:30.77, h1:58.89, t2:30.42, h2:77.29, t3:30.94, h3:59.53, t4:29.03, h4:38.47},
    {dt:1674111160000, t1:30.77, h1:58.89, t2:30.42, h2:77.29, t3:30.94, h3:59.53, t4:29.03, h4:38.47},
    {dt:1674111166000, t1:31.24, h1:76.33, t2:28.05, h2:64.17, t3:29.14, h3:44.97, t4:29.02, h4:52.49}
  ],
  ground: [
    {dt:1674111120000, h1:62.27, h2:69.61, h3:70.66, h4:68.83, h5:65.23, h6:66.82},
    {dt:1674111125000, h1:72.94, h2:62.61, h3:73.72, h4:75.40, h5:68.76, h6:66.47},
    {dt:1674111132000, h1:61.89, h2:75.24, h3:70.08, h4:71.64, h5:65.10, h6:67.63},
    {dt:1674111136000, h1:66.50, h2:63.59, h3:65.38, h4:64.88, h5:65.82, h6:67.74},
    {dt:1674111142000, h1:67.41, h2:72.98, h3:null,  h4:null,  h5:66.53, h6:72.44},
    {dt:1674111147000, h1:66.50, h2:63.59, h3:null,  h4:null,  h5:65.82, h6:67.74},
    {dt:1674111153000, h1:61.89, h2:75.24, h3:70.08, h4:71.64, h5:65.10, h6:67.63},
    {dt:1674111158000, h1:72.94, h2:62.61, h3:73.72, h4:75.40, h5:68.76, h6:66.47},
    {dt:1674111162000, h1:62.27, h2:69.61, h3:70.66, h4:68.83, h5:65.23, h6:66.82},
    {dt:1674111169000, h1:66.50, h2:63.59, h3:65.38, h4:64.88, h5:65.82, h6:67.74}
  ] };-->
</body>
</html>